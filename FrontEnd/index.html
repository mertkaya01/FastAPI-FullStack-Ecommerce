<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mert E-Commerce</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">ðŸš€ MertStore</a>
            <div class="d-flex align-items-center" id="navbar-actions">
                </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h2 class="mb-4 text-center">ðŸ”¥ PopÃ¼ler ÃœrÃ¼nler</h2>
        <div id="product-list" class="row">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <p>ÃœrÃ¼nler yÃ¼kleniyor...</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000";
        let allProducts = []; // Global Ã¼rÃ¼n deposu

        document.addEventListener("DOMContentLoaded", async () => {
            checkAuth();
            await loadProducts();
        });

        // --- ÃœRÃœNLERÄ° GETÄ°R ---
        // --- ÃœRÃœNLERÄ° GETÄ°R ---
        async function loadProducts() {
            const productList = document.getElementById("product-list");
            try {
                const response = await fetch(`${API_URL}/products/`);
                allProducts = await response.json(); 

                productList.innerHTML = ""; 

                allProducts.forEach(product => {
                    // --- RESÄ°M MANTIÄžI ---
                    // EÄŸer resim varsa: http://127.0.0.1:8000/static/images/resim.jpg
                    // Yoksa: Gri kutu (placeholder)
                    const imageUrl = product.image_url 
                        ? `${API_URL}${product.image_url}` 
                        : "https://via.placeholder.com/300";
                    // ---------------------

                    const cardHTML = `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 shadow-sm hover-effect">
                                <img src="${imageUrl}" class="card-img-top" alt="${product.name}" style="height: 200px; object-fit: cover;">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${product.name}</h5>
                                    <p class="card-text text-muted flex-grow-1">${product.description || "AÃ§Ä±klama yok"}</p>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <span class="h4 text-primary mb-0">${product.price} â‚º</span>
                                        <span class="badge bg-success">Stok: ${product.stock}</span>
                                    </div>
                                    <button class="btn btn-outline-primary w-100 mt-3" onclick="addToCart(${product.id})">Sepete Ekle</button>
                                </div>
                            </div>
                        </div>
                    `;
                    productList.innerHTML += cardHTML;
                });
            } catch (error) {
                console.error(error);
                productList.innerHTML = `<div class="alert alert-danger text-center">Sunucuya baÄŸlanÄ±lamadÄ±!</div>`;
            }
        }

        // --- SEPETE EKLE (STOK KONTROLLÃœ) ---
        function addToCart(productId) {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Sepete eklemek iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z!");
                window.location.href = "login.html";
                return;
            }

            // 1. ÃœrÃ¼nÃ¼ bul
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            // 2. Sepeti Ã§ek
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            const existingItem = cart.find(item => item.product_id === product.id);

            // --- STOK KONTROLÃœ BURADA ---
            let currentQty = existingItem ? existingItem.quantity : 0;
            
            if (currentQty + 1 > product.stock) {
                alert(`ÃœzgÃ¼nÃ¼z! "${product.name}" Ã¼rÃ¼nÃ¼nden stokta sadece ${product.stock} adet var.`);
                return; // Fonksiyonu burada durdur, ekleme yapma
            }
            // -----------------------------

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    product_id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    max_stock: product.stock // Cart sayfasÄ±nda da kontrol etmek iÃ§in
                });
            }

            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartCount();
            // alert(`${product.name} sepete eklendi!`);
        }

        // --- AUTH & NAVBAR ---
        function checkAuth() {
            const token = localStorage.getItem("token");
            const userEmail = localStorage.getItem("userEmail");
            const navbarActions = document.getElementById("navbar-actions");

            if (token) {
                navbarActions.innerHTML = `
                    <span class="text-light me-3 d-none d-md-block">ðŸ‘¤ ${userEmail}</span>
                    <a href="cart.html" class="btn btn-warning me-2 position-relative">
                        Sepetim 
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cart-count">0</span>
                    </a>
                    <button class="btn btn-outline-danger" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
                `;
                updateCartCount();
            } else {
                navbarActions.innerHTML = `
                    <a href="login.html" class="btn btn-light">GiriÅŸ Yap / KayÄ±t Ol</a>
                `;
            }
        }

        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            const countElement = document.getElementById("cart-count");
            if (countElement) {
                const total = cart.reduce((sum, item) => sum + item.quantity, 0);
                countElement.innerText = total;
            }
        }

        function logout() {
            if(confirm("Ã‡Ä±kÄ±ÅŸ yapÄ±lsÄ±n mÄ±?")) {
                localStorage.clear();
                window.location.reload();
            }
        }
    </script>
</body>
</html>